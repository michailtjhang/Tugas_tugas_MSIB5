* QUERY FUNCTION dan PROCEDURE & TRIGGER *

* TUGAS PERTEMUAN 09 *


* Soal 6.1 *
// Function kategori_harga
DELIMITER $$

CREATE FUNCTION kategori_harga(harga double)
RETURNS VARCHAR(20)
BEGIN
    DECLARE kategori VARCHAR(20);
    
    IF harga <= 500000 THEN
        SET kategori = 'murah';
    ELSEIF harga <= 3000000 THEN
        SET kategori = 'sedang';
    ELSEIF harga <= 10000000 THEN
        SET kategori = 'mahal';
    ELSE
        SET kategori = 'sangat mahal';
    END IF;
    
    RETURN kategori;
END $$

DELIMITER ;

SELECT kode, nama, harga_jual, kategori_harga(harga_jual) AS kategori FROM produk;

* Soal 6.2 *
// Procedure kurangi_stok
DELIMITER $$

CREATE PROCEDURE kurangi_stok (IN id_produk INT, IN jumlah INT)
BEGIN
  UPDATE produk
    SET stok = stok - jumlah
    WHERE id = id_produk;
END $$

DELIMITER ;


// Trigger trig_kurangi_stok
DELIMITER $$

CREATE TRIGGER trig_kurangi_stok AFTER INSERT ON pesanan_items
FOR EACH ROW
BEGIN
  CALL kurangi_stok(NEW.produk_id, NEW.qty);
END $$

DELIMITER ;

INSERT INTO pesanan_items (pesanan_id, produk_id, qty, harga)
VALUES (6, 12, 21, 315000);
